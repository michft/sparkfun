#include <avr/io.h>

#include "twi2c.h"

#ifndef F_CPU
#define F_CPU 16000000
#endif
#include <util/delay.h>
#include <stdio.h>
// len, len bytes of transaction, first even = wrinte, odd=read per i2c
// Start, len bytes, rep start, len bytes, 0 does stop
// 20 char

#define LCDADDR 0x7e

unsigned char sendlcd0[] = {
    91,
    LCDADDR, 
    0, // comsend 
    0x48,       //partial display duty ratio 
    0x64,       // 1/100 duty 
    0xA0,       //ADC select 
    0xC8,       //SHL select 
    0x44,       //initial Com0 register 
    0x00,       //scan from Com0 
    0xAB,       //OSC on 
    0x26,       
    0x81,       //set electronic volume 
    0x15,       //vopcode=0x1C 
    0x56,       //set 1/11 bias 
    0x64,       //3x 
//    delay(2, 
    0x2C,       
    0x66,       //5x 
//    delay(2, 
    0x2E,       
    // delay2
    0x2F,       //power control 
    0xF3,       //bias save circuit 
    0x00,       
    0x96,       //frc and pwm 
    0x38,       //external mode 
    0x75,       
    0x97,       //3frc, 45 pwm 
       //start 16‚Äêlevel grayscale settings 
0x80,0x00,0x81,0x00,0x82,0x00,0x83,0x00,0x84,0x06,0x85,0x06,0x86,0x06,0x87,0x06, 
0x88,0x0B,0x89,0x0B,0x8A,0x0B,0x8B,0x0B,0x8C,0x10,0x8D,0x10,0x8E,0x10,0x8F,0x10,
0x90,0x15,0x91,0x15,0x92,0x15,0x93,0x15,0x94,0x1A,0x95,0x1A,0x96,0x1A,0x97,0x1A,
0x98,0x1E,0x99,0x1E,0x9A,0x1E,0x9B,0x1E,0x9C,0x23,0x9D,0x23,0x9E,0x23,0x9F,0x23,
0xA0,0x27,0xA1,0x27,0xA2,0x27,0xA3,0x27,0xA4,0x2B,0xA5,0x2B,0xA6,0x2B,0xA7,0x2B,
0xA8,0x2F,0xA9,0x2F,0xAA,0x2F,0xAB,0x2F,0xAC,0x32,0xAD,0x32,0xAE,0x32,0xAF,0x32,
0xB0,0x35,0xB1,0x35,0xB2,0x35,0xB3,0x35,0xB4,0x38,0xB5,0x38,0xB6,0x38,0xB7,0x38,
0xB8,0x3A,0xB9,0x3A,0xBA,0x3A,0xBB,0x3A,0xBC,0x3C,0xBD,0x3C,0xBE,0x3C,0xBF,0x3C,
 //end grayscale settings 
0x38,0x74,0xAF, //display on 

    0,0,0,0,0 };



unsigned char sendlcda0[] = {
    24, LCDADDR,0x80,0x80,0x40, 'O', 'n', 'e', '=', '=','=','=','=', '+','+','+','+', '=','=','=','=', '=','O','n','e',
    0,0,0,0,0,0,0,0
};

unsigned char sendlcdb0[] = {
    24, LCDADDR,0x80,0xc0,0x40, 'T', 'w', 'o', '=', '=','=','=','=', '+','+','+','+', '=','=','=','=', '=','T','w','o',
    0, 0,0,0,0,0,0,0
};

#undef LCDADDR
#define LCDADDR 0x7c
unsigned char sendlcd1[] = {
    13, LCDADDR,0x00,0x30,0x30,0x30,0x39,
    0x14,0x7f,0x5f,0x6a,0x0f,0x06,0x01,
    0
};

unsigned char sendlcda1[] = {
    24, LCDADDR,0x80,0x80,0x40, 'O', 'n', 'e', '=', '=','=','=','=', '+','+','+','+', '=','=','=','=', '=','O','n','e',
    0,0,0,0,0,0,0,0
};

unsigned char sendlcdb1[] = {
    24, LCDADDR,0x80,0xc0,0x40, 'T', 'w', 'o', '=', '=','=','=','=', '+','+','+','+', '=','=','=','=', '=','T','w','o',
    0, 0,0,0,0,0,0,0
};


int main(void)
{
    unsigned xo = 0;

    for (;;) {
        TWIinit();

        TWIdocmd(sendlcd0);
        TWIdocmd(sendlcd1);
        _delay_ms(20);
        TWIdocmd(sendlcda0);
        TWIdocmd(sendlcdb0);
        TWIdocmd(sendlcda1);
        TWIdocmd(sendlcdb1);
        while( 1 ) {
            sprintf( (char *) &sendlcda0[5], "%6d",xo );
            sprintf( (char *) &sendlcda1[5], "%6d",xo++ );
            TWIdocmd(sendlcda0);
            TWIdocmd(sendlcda1);
        }
    }
}
